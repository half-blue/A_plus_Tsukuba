version: '3.8'
 
services:
 my_sql:
   platform: linux/amd64
   image: mariadb:10.0.33 # Same as ConoHa DB Server
   environment:
     MYSQL_PORT: 3306
     MYSQL_ROOT_PASSWORD: rootpass
     MYSQL_DATABASE: vhoi5_aplus_tsukuba
     TZ: Asia/Tokyo  
   ports:
     - 3307:3306 # To avoid port conflict, use 3307.
   # Change default charset
   command: mysqld --character-set-server=utf8 --collation-server=utf8_general_ci 
   ## `utf8mb4`を指定するのが正しいが，productionがutf8となっている問題があるため同じにしている．
   volumes:
     - data-volume:/var/lib/mysql
   healthcheck:
        test: mysqladmin ping -h 127.0.0.1 -u root -p$$MYSQL_ROOT_PASSWORD
     
 web:
    build: .
    ports:
      - 8000:8000
    command: python manage.py runserver 0.0.0.0:8000
    depends_on:
      my_sql:
        condition: service_healthy # wait db starting
 
volumes:
 data-volume:
